---
title: "Reproducible Figures Assignment"
output:
  html_document: default
  pdf_document: default
date: "2023-11-29"
purpose: A script to analyse the Palmer Penguins dataset.
---

# Installing and loading packages

```{r}
#Loading packages needed for this project, which should all be in the RENV folder. Also loading functions to clean data from Palmer Penguins dataset, found in a separate folder.
library(tidyverse)
library(palmerpenguins)
library(janitor)
library(here)
library(ggplot2)
library(patchwork)
library(ragg)
library(svglite)
library(multcomp)
```

# Data Preparation:

```{r echo=FALSE}
#Preserving and loading raw data in its own .csv file.

write.csv(penguins_raw, here("data","penguins_raw.csv"))
penguins_data_raw<-read.csv(here("data","penguins_raw.csv"))


#Investigating raw data, including seeing what column names are included.

head(penguins_data_raw)
colnames(penguins_data_raw)
```

```{r}
#Making function to clean column names of raw dataset.
cleaning_penguin_data_columns <- function(raw_data){
  print("Cleaning column names, simplifying species names, removing empty columns and rows and removing unnecessary columns/rows")
  raw_data %>% 
    clean_names() %>% #Cleans names of dataframe to make readable by computer.
    mutate(species = case_when(
      species == "Adelie Penguin (Pygoscelis adeliae)" ~ "Adelie",
      species == "Chinstrap penguin (Pygoscelis antarctica)" ~ "Chinstrap",
      species == "Gentoo penguin (Pygoscelis papua)" ~ "Gentoo")) %>% #mutate() changes name of column.
    remove_empty(c("rows", "cols")) %>% #removes empty rows and columns from dataframe.
    dplyr::select(-starts_with("delta")) %>% #removes any column with name starting with delta.
    dplyr::select(-comments)} #removes comments column.

#Cleaning raw data to generate a cleaner dataset, using function made above.
penguins_data_clean <- cleaning_penguin_data_columns(penguins_raw)
colnames(penguins_data_clean)
str(penguins_data_clean)

#Writing and saving new .csv file for cleaned data, which can be found in the "data" folder. 
write.csv(penguins_data_clean, here("data","penguins_data_clean.csv"))
penguins_data_clean <- read.csv(here("data", "penguins_data_clean.csv"))
```

# QUESTION 1: Data Visualisation for Science Communication

## a) Creating a bad figure
Create a figure using the Palmer Penguin dataset that is correct but badly communicates the data. Do not make a boxplot.

```{r bad figure code, echo=FALSE}
#Creating a bad bar graph showing how body mass differs between islands to answer question 1 of assessment.

bad_bargraph_island_png <- ggplot(penguins_data_clean) +
                           geom_col(aes(x=island, y=body_mass_g))
print(bad_bargraph_island_png)

#Saving the misleading plot as a .png file in the "figures" folder.

agg_png("figures/bad_bargraph_island_bodymass.png", 
        width = 20,
        height = 20,
        units = "cm",
        res = 200,
        scaling = 0.5)

print(bad_bargraph_island_png)
dev.off()
```

## b) Why is this misleading?
Write about how your design choices mislead the reader about the underlying data (200-300 words). Include references.

My graph is correct, but some design choices mislead the reader.

Firstly, there is no information about each data point, such as the species of penguin each sample is a member of. This is misleading; penguin species is likely a confounding variable which impacts body mass, and the island(s) inhabited. This therefore may mislead a reader as the effects of different species are not explicitly shown, so a misleading correlation may be represented on my graph.

The lack of error bars is also misleading as it is unclear to a reader how much measurements for a certain treatment (in this case each island) vary. Therefore, it is unclear whether the samples taken from each island are representative of the population on each island or whether there is wide variation and improper sampling, or whether the data are precise and/or accurate.

On this graph, I also only show a summary of the data, in this case maximum body mass in each category (i.e on each island). This is misleading because important information may be hidden. For example, the maximum body mass for each island might be an outlier. This is also represented in the axis labels, which do not state maximum body mass but instead state only "body_mass_g".

Moreover, axis labels as specified in the .png plot are also very small, making it hard for a reader to understand what the graph is showing. Readers must look very closely at the axis labels to see the variables being compared. This is misleading because by not clearly showing your axis labels and any units associated with them, readers are more likely to miss key details about exactly what is being compared or what relationship is suggested by a graph between, which may cause them to believe a false correlation is present.

# QUESTION 2: Data Pipeline

## Introduction

Many factors can impact beak morphology in birds, including foraging and thermoregulation. It has been shown that in many bird families, different species which inhabit different niches and have different foraging behaviours tend to evolve different bill shapes, which impacts variables like culmen length and depth (Friedman, 2019; Çakar, 2024). This pattern has been observed and tested in the birds of prey, but not in penguins (Çakar, 2024). The different sexes of many bird species also often have slightly different foraging behaviours outside of the breeding season, which could cause the evolution of different bill morphologies between the different sexes as each sex adapts to its different food sources (Gorman, 2014). Whether sex affects beak morphology is therefore an interesting question. It is known that species in the genus Pygoscelis display subtle sexual dimorphism in features like body mass, flipper length and bill size, with females usually being smaller than males. There is a possibility this will be reflected in the bill morphology of these penguins (Gorman, 2014; Polito, et al., 2012). To study this in detail and simplify the analysis, this analysis will focus on only one penguin species (the chinstrap penguin- Pygoscelis antarcicus) to ensure only sex is examined, not the effect of species. The chinstrap penguin has been chosen as it has been shown that it is the most dimorphic in culmen features, so will be an interesting species to study in this analysis.

This analysis, using data from the Palmer Penguins dataset, will test the relationship between culmen depth and sex in the chinstrap penguin.


```{r Data Preparation- taken from lesson materials provided by Lydia France, University of Oxford, 2024}
#All packages used can be found at the top of the document.

#These lines of code preserve raw data in a separate csv file so it is not lost and can be easily recovered.
write.csv(penguins_raw, here("data","penguins_raw.csv"))
penguins_data_raw<-read.csv(here("data","penguins_raw.csv"))


#Investigating data- allows initial analysis of what data were collected and what values have been recorded for each.

head(penguins_data_raw)
colnames(penguins_data_raw)

#Cleaning raw data to generate a cleaner dataset- removing superfluous variables and making data more easily read by R and by humans. Code for cleaning_penguin_columns function can be found in question 1.
penguins_data_clean<-cleaning_penguin_data_columns(penguins_data_raw)
colnames(penguins_data_clean)
str(penguins_data_clean)

#Factorising species as this is needed for Tukey test.
penguins_data_clean$species = as.factor(penguins_data_clean$species)
str(penguins_data_clean)

#Writing new .csv file for new, clean dataset to keep this safe in case any accidental changes are made or code breaks, to allow code to be easily recovered. 
write.csv(penguins_data_clean, here("data","penguins_data_clean.csv"))
penguins_data_clean <- read.csv(here("data", "penguins_data_clean.csv"))
```

```{r Exploratory figure looking at sexual dimorphism}
#Decided to look at effects of sexual dimorphism, so encoded separate graph which codes for identification of sex as well as species through different shapes.
# scale_shape_manual allows specification of shape so different sexes can be designated the      same shapes consistently making the figure more reproducible. 
#   Also allows for more in depth exploration of initial data before statistical analysis          conducted.
#Plotted a scatter plot as comparing two numerical variables (culmen length and depth).
bill_size_sex_exploratory <- ggplot(data=penguins_data_clean, 
                         aes(x=species, 
                            y=culmen_length_mm)) + 
                         geom_point(aes(color=species, shape=sex)) + 
                         geom_jitter(aes(color = species), alpha = 0.25, position =                                     position_jitter(width = 0.4, seed=0)) +
                         scale_colour_manual(values = species_colours) + 
                         scale_shape_manual(values = c(16, 17)) +
                         xlab("Culmen Length (mm)") + 
                         ylab("Culmen Depth (mm)")

#plot() function allows graph to be outputted.
plot(bill_size_sex_exploratory)

#Saving figure as .png file in figures folder.
agg_png("figures/bill_size__sex_exploratory.png", 
        width = 30,
        height = 15,
        units = "cm",
        res = 300,
        scaling = 1.125)

#Ensures figure saved in "figures" folder actually has graph encoded within it, as opposed to blank file.
print(bill_size_sex_exploratory)
dev.off()
```

```{r chinstrap specific dataset}
#Subsetting data to only include that on gentoo penguins.
chinstrap_data <- penguins_data_clean %>% 
               filter(species == "Chinstrap") %>% 
               na.omit()

#Writing new .csv file for chinstrap dataset to keep this safe in case any accidental changes are made or code breaks, to allow code to be easily recovered. 
write.csv(chinstrap_data, here("data","chinstrap_data.csv"))
chinstrap_data <- read.csv(here("data", "chinstrap_data.csv"))

#Creating histograms of data on culmen length in all chinstraps sampled to investigate data and assess distribution of data points, as well as effects of any transformations.
#Histogram for untransformed data:
chinstrap_length <- ggplot(data=chinstrap_data, aes(x=culmen_length_mm)) + geom_histogram()
chinstrap_length

#Log transforming culmen_length_mm using log10() function, and plotting histogram.
chinstrap_log_length <- log10(chinstrap_data$culmen_length_mm)
ggplot(data=chinstrap_data, aes(x=chinstrap_log_length)) + geom_histogram()

#Square-root transforming culmen_depth_mm using sqrt() function, and plotting histogram.
chinstrap_sqrt_length <- sqrt(chinstrap_data$culmen_length_mm)
ggplot(data = chinstrap_data, aes(x=chinstrap_sqrt_length)) + geom_histogram()

#No beneficial effect of transforming data, so will use untransformed data for further analysis.
#Can see clear bimodality, indicating some other variable is affecting culmen length in chinstrap penguins.
```

```{r Creating exploratory figure for chinstrap penguins in particular}
#Made exploratory figure to look more closely at one species in particular.
#Plotted a scatter plot as comparing two numerical variables (culmen length and depth).

#Making a colour blind-friendly palette useful for distinguishing sexes on figures. Specifying this ensures each sex is consistently represented by the same colours on any graph where sex is shown, making this document more accessible (as it is colour blind friendly) and more reproducible.
sex_colours <- c("FEMALE" = "purple",
                 "MALE" = "darkorange")

bill_size_exploratory_sex <- ggplot(data=chinstrap_data, 
                         aes(x=sex, 
                            y=culmen_length_mm)) + 
                         geom_point(aes(color=sex, shape=sex)) + 
                         geom_jitter(aes(color = sex), alpha = 0.25, position =                                     position_jitter(width = 0.4, seed=0)) +
                         scale_colour_manual(values = sex_colours) + 
                         scale_shape_manual(values = c(16, 17)) +
                         xlab("Culmen Length (mm)") + 
                         ylab("Culmen Depth (mm)")

plot(bill_size_exploratory_sex)

#Saving gentoo figure as .png files in figures folder.
agg_png("figures/bill_size_sex_exploratory.png", 
        width = 30,
        height = 15,
        units = "cm",
        res = 300,
        scaling = 1.125)

print(bill_size_exploratory_sex)
dev.off()

```

## Hypotheses

Effect of sex:
Null hypothesis: The mean culmen length of each sex will not be significantly different from that of the other.
Alternative hypothesis: The mean culmen depth of each sex will be significantly different from the other.

## Statistical Methods

In this analysis, an ANCOVA test will be conducted, to test whether sex affects culmen length, controlling for culmen depth. An ANCOVA is suitable for this analysis as there is a numerical response variable (culmen depth), a categorical explanatory variable (sex) and a couple of covariates which must be controlled for (culmen length and species). It is important to control for culmen depth; the depth of a beak may affect the length of a beak by itself. 

Null hypotheses for effect of sex in *P. antarcticus*: 
1: There is no effect of sex on culmen length. 
2: There is no effect of culmen depth on culmen length. 
3: There is no interaction between sex and culmen depth.

Alternative hypotheses for effect of sex in *P. antarcticus*: 
1: There is a significant effect of sex on culmen length. 
2: There is a significant effect of culmen depth on culmen length. 
3: There is a significant interaction between sex and culmen depth.


NB: The analyses presented here are not the same as in any referenced paper.

```{r Statistics- Gentoos}
#Creating model looing at effect of sex on culmen depth in chinstraps including interaction term.
chinstrap_log_bill_model_int <- lm(culmen_depth_mm ~ sex * chinstrap_log_length, chinstrap_data)

#Makes plots to ensure assumptions of analysis not violated.
par(mfrow = c(1,2))
plot(chinstrap_log_bill_model_int, which = 2)
plot(chinstrap_log_bill_model_int, which = 1)

#Checking outputs of analysis of model to assess adjusted R-squared and values for slope and intercept of each group.
summary(chinstrap_log_bill_model_int)

#Conducting an ANOVA of the above gentoo-specific model to assess what the significant effects are.
chinstrap_int_anova <- aov(chinstrap_log_bill_model_int)
summary(chinstrap_int_anova)

##Creating model looing at effect of sex on culmen depth in chinstraps without interaction term.
chinstrap_log_bill_model_noint <- lm(culmen_depth_mm ~ sex + chinstrap_log_length, chinstrap_data)

#Makes plots to ensure assumptions of analysis not violated.
par(mfrow = c(1,2))
plot(chinstrap_log_bill_model_noint, which = 2)
plot(chinstrap_log_bill_model_noint, which = 1)

#Checking outputs of analysis of model without interaction to assess adjusted R-squared and values for slope and intercept of each group.
summary(chinstrap_log_bill_model_noint)

#Conducting an ANOVA of the gentoo-specific model without interaction to assess what the significant effects are.
chinstrap_noint_anova <- aov(chinstrap_log_bill_model_noint)
summary(chinstrap_noint_anova)

#Conducting ANOVA to assess if there is a significant interaction between sex and culmen length in Gentoo penguins.
chinstrap_test_fit_diff <- anova(chinstrap_log_bill_model_int, chinstrap_log_bill_model_noint)
chinstrap_test_fit_diff
```

## Results & Discussion


```{r}
#Making results plot, showing relationship between culmen depth, culmen length and sex in gentoos.
chinstrap_plot_int <- 
ggplot(chinstrap_data, 
       aes(x=chinstrap_log_length, y=culmen_depth_mm, color = sex)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_colour_manual(values = sex_colours) + 
  xlab("Log Culmen length (mm)") + 
  ylab("Culmen depth (mm)") + 
  theme_bw()

plot(chinstrap_plot_int)

agg_png("figures/chinstrap_results_plot.png", 
        width = 30,
        height = 15,
        units = "cm",
        res = 300,
        scaling = 1.125)

print(chinstrap_plot_int)
dev.off()
```

## Conclusion

##References

*You will be marked on the following:*

a)  Your code for readability and functionality
b)  Your figures for communication
c)  Your text communication of your analysis

# QUESTION 3: Open Science

## a) GitHub

*Upload your RProject you created for **Question 2** and any files and subfolders used to GitHub. Do not include any identifiers such as your name. Make sure your GitHub repo is public.*

*GitHub link:*

*You will be marked on your repo organisation and readability.*

## b) Share your repo with a partner, download, and try to run their data pipeline.

*Partner's GitHub link:*

*You **must** provide this so I can verify there is no plagiarism between you and your partner.*

## c) Reflect on your experience running their code. (300-500 words)

-   *What elements of your partner's code helped you to understand their data pipeline?*

-   *Did it run? Did you need to fix anything?*

-   *What suggestions would you make for improving their code to make it more understandable or reproducible, and why?*

-   *If you needed to alter your partner's figure using their code, do you think that would be easy or difficult, and why?*

## d) Reflect on your own code based on your experience with your partner's code and their review of yours. (300-500 words)

-   *What improvements did they suggest, and do you agree?*

-   *What did you learn about writing code for other people?*
